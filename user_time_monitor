$username = 'misho'
# user name of the user that will be monitored
$emailSender = 'mymonitoraccount@gmail.com'
$emailRecipient = 'myemail@gmail.com'
$emailPassword = 'v3ry$Trongpassword'
$emailSubject = 'User Logon Time Exceeded 2 Hours'
$emailBody = 'The user ' + $username + ' has been logged in for more than 2 hours.'
$smtpServer = 'smtp.gmail.com'
$smtpPort = 587

while ($true) {
    try {
        $loggedIn = Get-CimInstance -ClassName Win32_ComputerSystem | Select-Object -ExpandProperty UserName
       # get username from windows
        if ($loggedIn -eq $username) {
            $logonTime = (Get-Date) - (Get-CimInstance -ClassName Win32_UserProfile | Where-Object { $_.LocalPath -match $username } | Select-Object -ExpandProperty Loaded)
            # match local path and username then select the time when profile was loaded and get date subtracted by loaded give us the time span of user logged 
            if ($logonTime.TotalHours -gt 2) {
            # check if more than 2 hours
                $smtp = New-Object Net.Mail.SmtpClient($smtpServer, $smtpPort)
                $smtp.EnableSsl = $true
                $smtp.Credentials = New-Object System.Net.NetworkCredential($emailSender, $emailPassword)
                $smtp.Send($emailSender, $emailRecipient, $emailSubject, $emailBody)
            }
        }
    } catch {
        Write-Host "Error occured: $_" -ForegroundColor Red
       # if cant send email wirte host that there is an error
    }
    Start-Sleep -Seconds 300
    # repeats every 5 mins
}
